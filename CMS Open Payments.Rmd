---
title: "R Notebook"
output: html_notebook
---

##Data Preperataion

```{r fetchdata, include=TRUE,echo=FALSE}
library(RSQLite)
library(DBI)
library(tidyr)

cwd <- paste0(getwd())
setwd(cwd)

download.file(url = "https://s3.amazonaws.com/istreet-assets/i0jhsz_Udi_Zl2jxJ-c-pQ/CMS_OPEN_PAYMENTS_DEC_2013.zip"
              ,destfile = "CMS_OPEN_PAYMENTS_DEC_2013.zip")
cmszip <- unzip("CMS_OPEN_PAYMENTS_DEC_2013.zip")
cmspayments <- read.csv(cmszip)

```


### Data Exploration
1.	Who are the top 10 companies making payments?  For the top five companies, what therapeutic areas are they investing in? 
Create data visualizations to compare and contrast these five companies and highlight any potential insights and tell a story based on what you see. 
(For the purposes of this question, assume that “Physician_Specialty” is equivalent to therapeutic area.) 


```{r toppayer, echo=TRUE,include=TRUE}
#names(cmspayments)
#Companies is "Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name"
toppayor <- aggregate(Total_Amount_of_Payment_USDollars ~ Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name
                                                        
                      ,cmspayments,FUN = sum)
colnames(toppayor) <- c("Company","TotalPayment")
toppayor <- head(toppayor[order(toppayor$TotalPayment, decreasing= TRUE),], n = 10)
toppayor
```


```{r sqltransform, echo=TRUE, include=TRUE}
rsqlcon <- dbConnect(RSQLite::SQLite(), ":memory:")

dbWriteTable(conn = rsqlcon
             ,"cmspaytable"
             ,cmspayments
             ,overwrite = TRUE)

topCompany <- RSQLite::dbGetQuery(conn = rsqlcon
                                ,"select Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name as Company
                                        ,sum(Total_Amount_of_Payment_USDollars) as TotalPayments
                                  from cmspaytable
                                  group by 1
                                  order by 2 desc
                                  limit 10"
                                  )
##has top company by revenue
dbWriteTable(conn = rsqlcon
             ,"topcompanytable"
             ,topCompany
             ,overwrite = TRUE)
print(topCompany)
```



```{r topspecialty, echo= TRUE, include= TRUE}
topspecialty <- RSQLite::dbGetQuery(conn = rsqlcon
                    , "select c.Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name as Company
                             ,c.Physician_Specialty
                             ,sum(c.Total_Amount_of_Payment_USDollars) as TotalPayments
                       from cmspaytable as c inner join (select distinct Company
                                          from topcompanytable
                                          order by topcompanytable.TotalPayments desc
                                          limit 5
                                          ) as tt on c.Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name
                                                   = tt.Company
                       group by 1,2
                       order by 3 desc,2,1
                    ")

print(topspecialty)
```













