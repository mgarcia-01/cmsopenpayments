---
title: "Compliance Analytics Open Payments Case "
author: "Michael Garcia"
date: "May 28, 2019"
output:
  html_notebook: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadpkg, include=TRUE,echo=FALSE, message=FALSE}
library(RSQLite)
library(DBI)
library(tidyr)
library(ggplot2)
#library(plotly)
```

## Data Preparation

```{r fetchdata, include=TRUE,echo=FALSE, message=FALSE}
cwd <- paste0(getwd())
setwd(cwd)

download.file(url = "https://s3.amazonaws.com/istreet-assets/i0jhsz_Udi_Zl2jxJ-c-pQ/CMS_OPEN_PAYMENTS_DEC_2013.zip"
              ,destfile = "CMS_OPEN_PAYMENTS_DEC_2013.zip")


cmszip <- unzip("CMS_OPEN_PAYMENTS_DEC_2013.zip")
cmspayments <- read.csv(cmszip)
### physician specialty has nas
cmspayments$Physician_Specialty <-  as.character(cmspayments$Physician_Specialty)
cmspayments$Physician_Specialty <- ifelse(nchar(cmspayments$Physician_Specialty)== 0
                                                , "NA"
                                                ,cmspayments$Physician_Specialty)
```


Split the string into columns
```{r physspecial_split,echo=TRUE, include=TRUE}

#within(cmspayments, FOO<-data.frame(do.call('rbind', strsplit(as.character(cmspayments$Physician_Specialty), '|', fixed=TRUE))))
physplit <- data.frame(do.call('rbind', strsplit(as.character(cmspayments$Physician_Specialty),'|',fixed=TRUE)))
colnames(physplit) <- c("PhysSpcOne","PhysSpcTwo","PhysSpcThree")
cmspayments <- cbind(cmspayments,physplit)

```
### Top Companies Prep
Bring top companies into dataframe.

```{r toppayer, echo=TRUE,include=TRUE}
#names(cmspayments)
#Companies is "Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name"
toppayor <- aggregate(Total_Amount_of_Payment_USDollars ~ Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name
                                                        
                      ,cmspayments,FUN = sum)
colnames(toppayor) <- c("Company","TotalPayment")
toppayor <- head(toppayor[order(toppayor$TotalPayment, decreasing= TRUE),], n = 10)
```




### Simplify the data manipulation
Using RSQLite, use SQL to simplify data manipulation.

Using the top companies dataframe, write to table. 
```{r sqltransform, echo=TRUE, include=TRUE}
rsqlcon <- dbConnect(RSQLite::SQLite(), ":memory:")

dbWriteTable(conn = rsqlcon
             ,"cmspaytable"
             ,cmspayments
             ,overwrite = TRUE)

topCompany <- RSQLite::dbGetQuery(conn = rsqlcon
                                ,"select Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name as Company
                                        ,sum(Total_Amount_of_Payment_USDollars) as TotalPayments
                                  from cmspaytable
                                  group by 1
                                  order by 2 desc
                                  limit 10"
                                  )
##has top company by revenue
dbWriteTable(conn = rsqlcon
             ,"topcompanytable"
             ,topCompany
             ,overwrite = TRUE)
print(topCompany)
```



Create a dataset with company, payment specialty, and total payments. Group by the attributes and sum the measures.
Then get the top companies with specialty only if they exist in the top 10 companies data frame.


```{r topspecialty, echo= TRUE, include= TRUE}
topspecialty <- RSQLite::dbGetQuery(conn = rsqlcon
                    , "select c.Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name as Company
                             ,c.Physician_Specialty
                             ,c.PhysSpcOne
                             ,c.PhysSpcTwo
                             ,c.PhysSpcThree
                             ,sum(c.Total_Amount_of_Payment_USDollars) as TotalPayments
                       from cmspaytable as c inner join (select distinct Company
                                          from topcompanytable
                                          order by topcompanytable.TotalPayments desc
                                          limit 5
                                          ) as tt on c.Submitting_Applicable_Manufacturer_or_Applicable_GPO_Name
                                                   = tt.Company
                       group by 1,2
                       order by 3 desc,2,1
                    ")

                      
print(topspecialty)
```

## Visualize
1. Top 10 companies barchart
2. Top 5 companies


```{r visualize,include=TRUE, echo=TRUE}

#plot_ly(x = c(topCompany$Company)
#       ,y = c(topCompany$TotalPayments)
#       ,type = "bar")
#par(mfrow - c(2,2))
g <- ggplot(topCompany,aes(Company,TotalPayments/1000000))
g+geom_bar(stat = "identity"
           ,colour = "dark blue"
           ,fill = "dodger blue") +theme(axis.text.x = element_text(angle=45
                                                                ,hjust = 1)
                                     ,axis.text.y = element_text(angle = 45)
                                     )+ labs(y = "Total Payments")+geom_line()+
                geom_hline(yintercept = mean(topCompany$TotalPayments/1000000), color="blue")
```








### Top Companies and Specialty Treemap
The treemap represents the top 5 companies and specialties invested. Depuy and
Mako invest in Orthopaedic Surgery. 
Jansen invests in Internal Medicine.
Pfizer and Allergan did not contain quality data to determine their largest
specialties invested in. 
Based on the treemap and not considering data that is not available: it can be
seen that the top therapeutic areas are different amongst the competitors and
may contribute to maintaining an advantage in the respective therapeutic areas.
Further look into annual trends may reveal any changes that may suggest withdrawal
or engagement in other areas


```{r treemap, echo=TRUE,include=TRUE}

### use ping to produce image and control size.
specialtytree <- file.path(getwd(),paste("specialtytreemap",".png",sep = ""))
png(filename = specialtytree,
    width = 1000, height = 850, units = "px", pointsize = 12,
    bg = "white",  res = NA,## ...,
    ##type = c("cairo", "cairo-png", "Xlib", "quartz"), 
    antialias = c("default")
)


## use PhysSpcTwo for more specific view
treemap::treemap(dtf = topspecialty, index = c("Company","PhysSpcTwo")
                 ,type = "index"
                 , fontsize.labels=c(12,10,10)
                 ,vSize = "TotalPayments"
                 ,vColor = "Physician_Specialty"
                 ,command.line.output = FALSE
                 #,fontface.labels = "bold"
                 ,palette = "Set1"
                 ,fun.aggregate = "sum"
                 , align.labels=list(
                                      c("center", "center"), 
                                      c("center", "bottom")
                                      )
                  )
dev.off()
```

![Specialty Tree Map](specialtytreemap.png)


### Physician Group Analysis

Based on the summary, the highest Average Payment is received by Teaching Hospitals.
The Medical Doctors received the 74% of the payments while Chiropractors received .001%

Medical doctors also received the highest quantity of payments at 86%. 
Doctor of Optometry received 2% while only receiving 1% of the payments from total.



```{r trends, echo=TRUE, include=TRUE}

phys <- cmspayments[c("Physician_Primary_Type"
                      ,"Total_Amount_of_Payment_USDollars"
                      ,"Physician_Profile_ID","Covered_Recipient_Type")]

physmean <- aggregate(Total_Amount_of_Payment_USDollars~Covered_Recipient_Type+Physician_Primary_Type
                     ,data = phys
                     ,FUN = "mean"
                     )
#physmax <- aggregate(Total_Amount_of_Payment_USDollars~phys$Covered_Recipient_Type+phys$Physician_Primary_Type
#                     ,data = phys
#                     ,FUN = "max"
#                     )

physidcount <- aggregate(Total_Amount_of_Payment_USDollars~Covered_Recipient_Type+Physician_Primary_Type
                     ,data = phys
                     ,FUN = "length"
                     )
physsum <- aggregate(Total_Amount_of_Payment_USDollars~Covered_Recipient_Type+Physician_Primary_Type
                     ,data = phys
                     ,FUN = "sum"
                     )

physummary <- merge(x=physmean,y=physidcount, by = c("Physician_Primary_Type"
                                               ,"Covered_Recipient_Type")
                    )
colnames(physummary) <- c("Physician_Primary_Type","Covered_Recipient_Type"
                          ,"AveragePayment","NumberofPayments")

physummary <- merge(x=physummary,y=physsum,by = c("Physician_Primary_Type"
                                               ,"Covered_Recipient_Type")
                  )
colnames(physummary) <- c("Physician_Primary_Type","Covered_Recipient_Type"
                          ,"AveragePayment","NumberofPayments","TotalPayments")

physummary$PctOfTotal <- physummary$TotalPayments/sum(physummary$TotalPayments)
physummary$QtyPaymentsPctofTotal <- physummary$NumberofPayments/sum(physummary$NumberofPayments)


print(physummary)
                                                         
```




